name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check required env vars
        # Only run the check if any email-related secrets are present in the repository
        if: ${{ secrets.SENDGRID_API_KEY != '' || secrets.SMTP_HOST != '' || secrets.SMTP_USER != '' || secrets.SMTP_PASS != '' || secrets.CONTACT_TO != '' }}
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          CONTACT_TO: ${{ secrets.CONTACT_TO }}
        run: |
          echo "Running env check (email secrets present)"
          node scripts/check_env.js
      - name: Env check skipped
        if: ${{ secrets.SENDGRID_API_KEY == '' && secrets.SMTP_HOST == '' && secrets.SMTP_USER == '' && secrets.SMTP_PASS == '' && secrets.CONTACT_TO == '' }}
        run: echo "No email secrets configured in Actions; skipping email env check. Set SENDGRID_API_KEY or SMTP_* + CONTACT_TO as repository secrets to enable the check."

      - name: Build
        run: npm run build
